# バイトコード仕様書

## 命令の種類

### 四則演算

add, sub, mul, div

### 比較演算

equal, greater

### 論理演算

and, or

### その他演算

join

### メインスタック

push, pop

### オペスタック

load, (store)

### ブロック

block, call, return

### ジャンプ

jump, jumpif, jumpifn

## 命令一覧

### add

オペスタック内の2つの要素を加算する

#### 処理手順

1. オペスタックを2回ストアする
2. 演算結果をメインスタックにプッシュする

### and

オペスタック内の2つの要素の論理積を演算する

#### 処理手順

1. オペスタックを2回ストアする
2. 演算結果をメインスタックにプッシュする

### div

オペスタック内の2つの要素を除算する

#### 処理手順

1. オペスタックを2回ストアする
2. 演算結果をメインスタックにプッシュする

### equal

2つの値が一致するか判定する

#### 処理手順

1. オペスタックを2回ストアする
2. 演算結果をメインスタックにプッシュする (2_0 or 2_1)

### join

2つの値を連結する

1. オペスタックを2回ストアする
2. 演算結果をメインスタックにプッシュする

#### 処理手順

### load <要素数>

メインスタック内の後ろから要素数分の値をコピーしてオペスタックにプッシュする

### mul

オペスタック内の2つの要素を乗算する

#### 処理手順

1. オペスタックを2回ストアする
2. 演算結果をメインスタックにプッシュする

### and

オペスタック内の2つの要素の論理和を演算する

#### 処理手順

1. オペスタックを2回ストアする
2. 演算結果をメインスタックにプッシュする

### pop

メインスタックの値を1回ポップする

### push <値>

メインスタックに値をプッシュする

### return

ブロックから抜け出す

### sub

オペスタック内の2つの要素を減算する

#### 処理手順

1. オペスタックを2回ストアする
2. 演算結果をメインスタックにプッシュする

## 例

### 条件分岐

```
0:      load        1           ; 条件をロード
1:      jumpif      3           ; 条件に当てはまる場合はジャンプ

2:      ; 任意の処理

3:      ; 以後の処理
```

### 条件分岐

```
0:      load        1           ; 条件をロード
1:      jumpifn     4           ; 条件に当てはまらない場合は処理2にジャンプ

2:      ; 任意の処理1
3:      jump        5           ; 条件分岐の外にジャンプ

4:      ; 任意の処理2

5:      ; 以後の処理
```

### ループ

```
0:      push        123_32      ; ループ回数
1:      push        0_32        ; インデクサ

2:      load        2           ; ループ回数とインデクサをロード
3:      equal                   ; 一致するか判定
4:      load        1           ; 判定結果をロード
5:      jumpif      19          ; ループ処理の外にジャンプ
6:      pop                     ; 判定結果をポップ

7:      load        2           ; ループ回数とインデクサをロード
8:      greater                 ; インデクサを比較
9:      load        1           ; 判定結果をロード
10:     jumpif      19          ; ループ処理の外にジャンプ
11:     pop                     ; 判定結果をポップ

12:     ; 任意の処理

13:     load        1           ; インデクサをロード
14:     pop                     ; インデクサをポップ
15:     push        1_2         ; インデックスに加算する値
16:     load        1           ; 加算する値をロード
17:     add                     ; インデックスを加算

18:     jump        2           ; インデクサの判定部分にジャンプ

19:     pop                     ; インデクサをポップ
20:     pop                     ; ループ回数をポップ

21:     ; 以降の処理
```

## バイトコード例

```js
Hello


const(str[] args)
    for 123
        println("Hello, world!")
    end
    println("Hi!")
end


println()
end
```

```
ORINCHAN                        ; マジックコード

; ブロック定義

0:      1ef211c31e849269        Hello.const

; エントリポイント (後で変更する; new命令を追加)

0:      1ef211c31e849269

; ブロックの定義

0:      block       1ef211c31e849269    ; constを定義
1:      push        32_123      ; ループ回数
2:      push        32_0        ; インデクサ

3:      load        2           ; ループ回数とインデクサをロード
4:      equal                   ; 一致するか判定
5:      load        1           ; 判定結果をロード
6:      jumpif      19          ; ループ処理の外にジャンプ
7:      pop                     ; 判定結果をポップ

8:      load        2           ; ループ回数とインデクサをロード
9:      greater                 ; インデクサを比較
10:     load        1           ; 判定結果をロード
11:     jumpif      19          ; ループ処理の外にジャンプ
12:     pop                     ; 判定結果をポップ

13:     call        0577de596a4147f5    ; println("Hello, world!")

14:     load        1           ; インデクサをロード
15:     pop                     ; インデクサをポップ
16:     push        2_1         ; インデックスに加算する値
17:     load        1           ; 加算する値をロード
18:     add                     ; インデックスを加算

19:     jump        2           ; インデクサの判定部分にジャンプ

20:     pop                     ; インデクサをポップ
21:     pop                     ; ループ回数をポップ
22:     return                  ; ブロックを抜ける

22:     call        0577de596a4147f5    ; println("Hey!")

0:      block       0577de596a4147f5    ; printlnを定義
1:      push        arg_0       ; 引数内の出力する文字列をプッシュ
2:      push        16_1        ; コンソール出力のシステム命令コードをプッシュ
3:      load        2           ; 文字列と命令コードをロード
4:      syscall                 ; コンソールに出力
5:      return                  ; ブロックを抜ける
```
